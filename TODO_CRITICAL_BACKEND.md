# TODO: Critical Backend Fixes (DroneApp)

Список задач переписан по актуальным недостаткам из `backend/critical errors/things to fix.md`.
Порядок — по приоритету выполнения.

## P0 - Немедленно (блокирует релиз)

### Полноценная JWT-аутентификация и авторизация
- Спроектировать JWT: access/refresh, issuer/audience, exp/nbf, key rotation, kid.
- Ввести роли/скоупы и проверить их на всех HTTP и WS эндпоинтах.
- Добавить единый формат ошибок 401/403 и трассировку (trace_id).
- Обновить клиент и симулятор на отправку Authorization: Bearer <access>.

### Контракт создания заказа и выдачи токена
- Ввести endpoint создания заказа/трекинга и выдачи server-signed claims (order_id, scope, exp).
- Убрать генерацию orderId на клиенте без подтверждения сервера.
- Привязать доступ к телеметрии/позициям к claims заказа.

### Запуск трекинга/симуляции должен быть согласован
- Определить единый сценарий запуска (HTTP POST или WS message) и закрепить его контрактом.
- Убрать “пустой” HTTP fallback: если нет телеметрии — вернуть понятную ошибку и не ломать UX.
- Обновить клиент и симулятор под единый поток запуска и статусов.

### Безопасный канал
- Принудить HTTPS/WSS на уровне ingress/reverse proxy.
- Зафиксировать редиректы HTTP -> HTTPS, WS -> WSS.
- Запретить незашифрованные каналы в клиенте.

## P1 - Высокий приоритет

### Согласованность спецификации и реализации
- Привести `openapi.yaml` в соответствие реальному backend или реализовать заявленные endpoints.
- Уточнить публичность `/geocode` и `/reverse-geocode` (либо public, либо явно protected).
- Задокументировать JWT требования для интеграций.

### База данных для продакшна
- Перейти на PostgreSQL.
- Включить миграции (Alembic).
- Добавить индексы, внешние ключи и проверки целостности.

### Защита от перегрузки
- Ввести rate‑limit на критичные endpoints (geocode, telemetry, tracking).
- Перевести блокирующие SQLite/IO операции из async‑эндпоинтов в безопасную модель
  (async DB драйвер/worker pool).

## P2 - Устойчивость и эксплуатация

### Валидация входных данных
- Проверки диапазонов координат, прогресса, статусов.
- Отклонение некорректных payload с 400 и понятным описанием.
- Базовые тесты валидации.

### Логи и наблюдаемость
- Заменить print/debugPrint на структурный logger.
- Добавить корреляцию по order_id/trace_id.
- Минимальные метрики: активные заказы, ошибки /telemetry, задержки WS.

### Разделение окружений и демо-данные
- Разделить демо и прод БД, сидинг только в dev.
- Отключаемые demo флаги через env.

## P3 - Качество и гигиена репозитория

- Удалить или вынести `main_old.py` и тестовые скрипты из продового пути запуска.
- Убрать артефакты окружения/сборки из репозитория (.venv, build, drone.db) и закрепить в .gitignore.
- Централизовать конфигурацию (env + config schema), убрать hardcode 127.0.0.1.

## Проверки после внедрения

- Все protected endpoints требуют JWT, без токена возвращают 401/403.
- Клиент успешно получает токен/claims на заказ и трекает доставку.
- Симуляция запускается только по утвержденному контракту.
- HTTPS/WSS обязательны в проде.
- Спецификация `openapi.yaml` соответствует работающему API.
