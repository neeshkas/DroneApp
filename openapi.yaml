openapi: "3.0.3"

info:
  title: Magnum Drone Delivery API
  description: |
    Backend API for Magnum grocery delivery using autonomous drones.
    Provides RESTful endpoints and WebSocket for real-time drone position streaming.

    # Security
    JWT Bearer authentication secures all endpoints except health and geocoding.
    Optionally supports API Key (if enabled by contract).

    # Real-time Tracking (WebSocket)
    WebSocket endpoint (demo / simulation):
    - `wss://api.magnumdrone.delivery/ws/drone`

    WebSocket endpoint (production delivery tracking, by delivery_id):
    - `wss://api.magnumdrone.delivery/ws/v1/deliveries/{delivery_id}`

    WebSocket message types (production):
    - `TELEMETRY` — coordinates, battery, link quality, temperature, ETA
    - `STATUS` — delivery status changes

  version: "1.0.0"
  contact:
    name: Drone Platform Integration Team
    email: support@aaag.kz

servers:
  - url: https://api.magnumdrone.delivery/v1
    description: Production server
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Geocoding
    description: Forward and reverse geocoding services via OpenStreetMap Nominatim
  - name: Stores
    description: Store information endpoints
  - name: Products
    description: Product catalog endpoints
  - name: Drone
    description: Drone position and flight simulation endpoints (prototype)
  - name: Deliveries
    description: B2B delivery lifecycle endpoints for Magnum integration (production contract)
  - name: Tracking
    description: Delivery tracking (REST + WebSocket schemas)
  - name: Webhooks
    description: Callback events pushed to Magnum (optional)

security:
  - bearerAuth: []
  - apiKeyAuth: []

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-KEY

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      description: |
        Ключ идемпотентности для безопасных повторов создания доставки.
        Magnum должен генерировать UUID на каждый логический запрос создания доставки.
      schema:
        type: string
        format: uuid

  headers:
    XRateLimitLimit:
      description: Maximum requests allowed in the current time window
      schema:
        type: integer
        example: 100
    XRateLimitRemaining:
      description: Remaining requests in the current time window
      schema:
        type: integer
        example: 95
    XRateLimitReset:
      description: Unix timestamp when the rate limit window resets
      schema:
        type: integer
        example: 1673456700

  schemas:

    # -------------------------
    # Common error model
    # -------------------------
    ErrorCode:
      type: string
      description: Специфичные коды ошибок (для устойчивой обработки на стороне Magnum)
      enum:
        - INVALID_REQUEST
        - INVALID_COORDINATES
        - DUPLICATE_ORDER
        - DELIVERY_NOT_POSSIBLE
        - UNAUTHORIZED
        - RATE_LIMIT_EXCEEDED
        - TEMPORARY_UNAVAILABLE
        - DELIVERY_NOT_FOUND
        - INVALID_STATE_TRANSITION
        - INTERNAL_ERROR

    ErrorResponse:
      type: object
      required: [error, message, trace_id]
      properties:
        error:
          $ref: "#/components/schemas/ErrorCode"
        message:
          type: string
          example: "Latitude/Longitude out of bounds"
        details:
          type: object
          description: Дополнительные поля, полезные для диагностики
          additionalProperties: true
        trace_id:
          type: string
          description: Correlation/trace id for support
          example: "d9f1b2c3a1"

    RateLimitResponse:
      type: object
      required: [error, message, retry_after_seconds]
      properties:
        error:
          type: string
          enum: [RATE_LIMIT_EXCEEDED]
        message:
          type: string
          example: "Too many requests"
        retry_after_seconds:
          type: integer
          example: 30

    # -------------------------
    # Existing (autogen) models
    # -------------------------
    Error:
      type: object
      description: Error response (legacy)
      properties:
        code:
          type: integer
          example: 400
        message:
          type: string
          example: Invalid request parameters

    GeocodeResult:
      type: object
      description: Single geocoding result from Nominatim
      properties:
        place_id:
          type: string
          example: "123456789"
        display_name:
          type: string
          example: "123 Main St, City, Country"
        lat:
          type: string
          example: "40.712776"
        lon:
          type: string
          example: "-74.005974"
        type:
          type: string
          example: "house"

    AddressDetail:
      type: object
      description: Address details from reverse geocoding
      properties:
        place_id:
          type: string
          example: "987654321"
        display_name:
          type: string
          example: "123 Main St, City, Country"
        address:
          type: object
          description: Address components
          properties:
            house_number:
              type: string
              example: "123"
            road:
              type: string
              example: "Main St"
            city:
              type: string
              example: "City"
            state:
              type: string
              example: "State"
            country:
              type: string
              example: "Country"
            postcode:
              type: string
              example: "12345"

    Store:
      type: object
      description: Store location and details
      properties:
        id:
          type: string
          description: Unique store identifier
          example: "store_001"
        name:
          type: string
          example: "Magnum Central"
        address:
          type: string
          example: "123 Main St, City, Country"
        latitude:
          type: number
          format: float
          example: 40.712776
        longitude:
          type: number
          format: float
          example: -74.005974

    Product:
      type: object
      description: Product details linked to a store
      properties:
        id:
          type: string
          description: Unique product identifier
          example: "prod_001"
        storeId:
          type: string
          description: Store identifier this product belongs to
          example: "store_001"
        title:
          type: string
          example: "Organic Apples"
        price:
          type: number
          format: float
          example: 3.99
        weight:
          type: number
          format: float
          description: Weight in kilograms
          example: 0.5
        imageUrl:
          type: string
          format: uri
          example: "https://magnumdrone.delivery/images/prod_001.jpg"

    DronePositionLegacy:
      type: object
      description: Drone position and delivery status for legacy HTTP polling
      properties:
        lat:
          type: number
          format: float
          example: 40.712776
        lng:
          type: number
          format: float
          example: -74.005974
        delivered:
          type: boolean
          example: false

    WebSocketDronePositionMessage:
      type: object
      description: Real-time drone flight update message sent over WebSocket (demo)
      properties:
        type:
          type: string
          enum: [drone_position]
          example: drone_position
        lat:
          type: number
          format: float
          example: 40.712776
        lng:
          type: number
          format: float
          example: -74.005974
        delivered:
          type: boolean
          example: false
        progress:
          type: number
          format: float
          minimum: 0
          maximum: 1
          example: 0.5
        status:
          type: string
          example: "In transit"
        orderId:
          type: string
          example: "order_12345"

    # -------------------------
    # Production (B2B) delivery models
    # -------------------------
    DeliveryStatus:
      type: string
      enum:
        - CREATED
        - VALIDATING
        - REJECTED
        - ASSIGNED
        - LOADING
        - READY_TO_TAKEOFF
        - IN_FLIGHT
        - APPROACHING
        - DELIVERED
        - RETURNING
        - FAILED
        - CANCELLED

    Customer:
      type: object
      required: [name, phone]
      properties:
        name:
          type: string
          example: "Иван Иванов"
        phone:
          type: string
          example: "+77071234567"

    DeliveryAddress:
      type: object
      required: [latitude, longitude, address_text]
      properties:
        latitude:
          type: number
          format: double
          example: 43.238949
        longitude:
          type: number
          format: double
          example: 76.889709
        altitude:
          type: number
          format: double
          example: 0
        address_text:
          type: string
          example: "Алматы, ул. Абая 10"
        entrance:
          type: string
          example: "2"
        floor:
          type: integer
          example: 5
        apartment:
          type: string
          example: "52"
        comment:
          type: string
          example: "Позвонить за 5 минут"

    Payload:
      type: object
      required: [weight_kg]
      properties:
        weight_kg:
          type: number
          format: double
          example: 2.4
        volume_l:
          type: number
          format: double
          example: 4.0
        temperature_required:
          type: boolean
          example: true
        min_temperature_c:
          type: number
          example: 2
        max_temperature_c:
          type: number
          example: 6
        fragile:
          type: boolean
          example: false

    PreferredDeliveryWindow:
      type: object
      properties:
        from_utc:
          type: string
          format: date-time
          example: "2026-01-08T10:00:00Z"
        to_utc:
          type: string
          format: date-time
          example: "2026-01-08T12:00:00Z"

    CreateDeliveryRequest:
      type: object
      required: [order_id, customer, delivery_address, payload]
      properties:
        order_id:
          type: string
          description: Order identifier in Magnum system
          example: "MAG-923842"
        customer:
          $ref: "#/components/schemas/Customer"
        delivery_address:
          $ref: "#/components/schemas/DeliveryAddress"
        payload:
          $ref: "#/components/schemas/Payload"
        preferred_delivery_window:
          $ref: "#/components/schemas/PreferredDeliveryWindow"

    CreateDeliveryResponse:
      type: object
      required: [delivery_id, order_id, status]
      properties:
        delivery_id:
          type: string
          example: "DLV-100239"
        order_id:
          type: string
          example: "MAG-923842"
        status:
          $ref: "#/components/schemas/DeliveryStatus"
        created_at_utc:
          type: string
          format: date-time
          example: "2026-01-08T09:12:00Z"
        tracking:
          type: object
          properties:
            status_url:
              type: string
              example: "/v1/deliveries/DLV-100239"
            websocket_url:
              type: string
              example: "wss://api.magnumdrone.delivery/ws/v1/deliveries/DLV-100239"

    DeliveryStatusResponse:
      type: object
      required: [delivery_id, order_id, status]
      properties:
        delivery_id:
          type: string
          example: "DLV-100239"
        order_id:
          type: string
          example: "MAG-923842"
        status:
          $ref: "#/components/schemas/DeliveryStatus"
        eta_utc:
          type: string
          format: date-time
          example: "2026-01-08T09:35:00Z"
        last_update_utc:
          type: string
          format: date-time
          example: "2026-01-08T09:20:21Z"

    CancelDeliveryRequest:
      type: object
      required: [reason]
      properties:
        reason:
          type: string
          example: "CUSTOMER_REQUEST"

    DronePosition:
      type: object
      required: [latitude, longitude]
      properties:
        latitude:
          type: number
          format: double
          example: 43.240102
        longitude:
          type: number
          format: double
          example: 76.892100
        altitude_m:
          type: number
          example: 120
        speed_mps:
          type: number
          example: 14.5
        heading_deg:
          type: number
          example: 270
        battery_percent:
          type: integer
          minimum: 0
          maximum: 100
          example: 78
        gps_accuracy_m:
          type: number
          example: 3.2
        link_quality_percent:
          type: integer
          minimum: 0
          maximum: 100
          example: 92

    TelemetryMessage:
      type: object
      required: [type, timestamp_utc, delivery_id, drone]
      properties:
        type:
          type: string
          enum: [TELEMETRY]
        timestamp_utc:
          type: string
          format: date-time
          example: "2026-01-08T09:20:21Z"
        delivery_id:
          type: string
          example: "DLV-100239"
        drone:
          $ref: "#/components/schemas/DronePosition"
        payload:
          type: object
          properties:
            temperature_c:
              type: number
              example: 4.1
        eta_utc:
          type: string
          format: date-time
          example: "2026-01-08T09:35:00Z"

    StatusMessage:
      type: object
      required: [type, timestamp_utc, delivery_id, status]
      properties:
        type:
          type: string
          enum: [STATUS]
        timestamp_utc:
          type: string
          format: date-time
          example: "2026-01-08T09:22:00Z"
        delivery_id:
          type: string
          example: "DLV-100239"
        status:
          $ref: "#/components/schemas/DeliveryStatus"

    WebhookEvent:
      type: object
      required: [event_id, event_type, timestamp_utc, order_id, delivery_id]
      properties:
        event_id:
          type: string
          example: "EVT-9001"
        event_type:
          type: string
          enum: [DELIVERY_STATUS, INCIDENT_LINK_LOSS, INCIDENT_TEMPERATURE_OUT_OF_RANGE]
        timestamp_utc:
          type: string
          format: date-time
          example: "2026-01-08T09:37:11Z"
        order_id:
          type: string
          example: "MAG-923842"
        delivery_id:
          type: string
          example: "DLV-100239"
        status:
          $ref: "#/components/schemas/DeliveryStatus"
        details:
          type: object
          additionalProperties: true

paths:

  # -------------------------
  # EXISTING (autogen) endpoints
  # -------------------------
  /:
    get:
      tags: [Health]
      summary: Health and status check
      operationId: getHealthStatus
      responses:
        "200":
          description: Service is operational
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
      security: []

  /geocode:
    get:
      tags: [Geocoding]
      summary: Forward geocoding using Nominatim
      operationId: getGeocode
      parameters:
        - name: q
          in: query
          description: Query string to geocode (e.g., address or place name)
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of geocoding results
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GeocodeResult"
        "502":
          description: External geocoding service failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security: []

  /reverse-geocode:
    get:
      tags: [Geocoding]
      summary: Reverse geocoding using Nominatim
      operationId: getReverseGeocode
      parameters:
        - name: lat
          in: query
          description: Latitude coordinate
          required: true
          schema:
            type: number
            format: float
        - name: lng
          in: query
          description: Longitude coordinate
          required: true
          schema:
            type: number
            format: float
      responses:
        "200":
          description: Address details for given coordinates
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddressDetail"
        "502":
          description: External geocoding service failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security: []

  /stores:
    get:
      tags: [Stores]
      summary: Retrieve list of all stores
      operationId: listStores
      responses:
        "200":
          description: Array of store objects
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Store"

  /products:
    get:
      tags: [Products]
      summary: Retrieve list of products, optionally filtered by store
      operationId: listProducts
      parameters:
        - name: store_id
          in: query
          description: Filter products by store ID
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Array of product objects
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Product"

  /drone/position:
    get:
      tags: [Drone]
      summary: Legacy HTTP polling for drone position and delivery status
      operationId: getDronePositionLegacy
      parameters:
        - name: orderId
          in: query
          description: Order identifier to track drone delivery
          required: true
          schema:
            type: string
        - name: start_lat
          in: query
          description: Optional start latitude coordinate
          required: false
          schema:
            type: number
            format: float
        - name: start_lng
          in: query
          description: Optional start longitude coordinate
          required: false
          schema:
            type: number
            format: float
        - name: end_lat
          in: query
          description: Optional end latitude coordinate
          required: false
          schema:
            type: number
            format: float
        - name: end_lng
          in: query
          description: Optional end longitude coordinate
          required: false
          schema:
            type: number
            format: float
      responses:
        "200":
          description: Current drone position and delivery status
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DronePositionLegacy"
        "400":
          description: Missing or invalid parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /ws/drone:
    get:
      tags: [Drone]
      summary: WebSocket endpoint for real-time drone flight simulation updates (demo)
      operationId: wsDroneFlightSimulation
      description: |
        WebSocket connection to start and receive drone position updates (prototype/demo).

        Client sends JSON message to start tracking:
        {
          "type": "start_tracking",
          "orderId": "string",
          "start_lat": float (optional),
          "start_lng": float (optional),
          "end_lat": float (optional),
          "end_lng": float (optional)
        }

        Server sends periodic updates every 5 seconds with:
        {
          "type": "drone_position",
          "lat": float,
          "lng": float,
          "delivered": boolean,
          "progress": float (0.0-1.0),
          "status": string,
          "orderId": string
        }
      security:
        - bearerAuth: []

  # -------------------------
  # PRODUCTION B2B endpoints for Magnum
  # -------------------------
  /deliveries:
    post:
      tags: [Deliveries]
      summary: Создать доставку (B2B)
      operationId: createDelivery
      description: |
        Создаёт новую доставку в системе Drone Platform по заказу Magnum.
        Требует Idempotency-Key для безопасных повторов.

        Ошибки:
        - DUPLICATE_ORDER (409) — доставка по order_id уже существует
        - DELIVERY_NOT_POSSIBLE (422) — доставка невозможна (зона, ограничения, погодные условия, масса и т.д.)
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDeliveryRequest"
      responses:
        "201":
          description: Доставка создана
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateDeliveryResponse"
        "400":
          description: Неверный запрос (INVALID_REQUEST)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: INVALID_REQUEST
                message: "Missing required field 'customer'"
                trace_id: "d9f1b2c3a1"
        "409":
          description: Доставка уже существует (DUPLICATE_ORDER)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: DUPLICATE_ORDER
                message: "Order MAG-923842 already has active delivery"
                trace_id: "d9f1b2c3a2"
        "422":
          description: Доставка невозможна (DELIVERY_NOT_POSSIBLE)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: DELIVERY_NOT_POSSIBLE
                message: "Delivery location is outside service area"
                trace_id: "d9f1b2c3a3"
        "429":
          description: Превышен лимит запросов (RATE_LIMIT_EXCEEDED)
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RateLimitResponse"
        "500":
          description: Внутренняя ошибка (INTERNAL_ERROR)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: INTERNAL_ERROR
                message: "Internal server error"
                trace_id: "d9f1b2c3a4"

  /deliveries/{delivery_id}:
    get:
      tags: [Deliveries]
      summary: Получить статус доставки (B2B)
      operationId: getDeliveryStatus
      parameters:
        - in: path
          name: delivery_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Статус доставки
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeliveryStatusResponse"
        "404":
          description: Доставка не найдена (DELIVERY_NOT_FOUND)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: DELIVERY_NOT_FOUND
                message: "Delivery DLV-999999 not found"
                trace_id: "d9f1b2c3a5"
        "429":
          description: Превышен лимит запросов (RATE_LIMIT_EXCEEDED)
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RateLimitResponse"

  /deliveries/{delivery_id}/cancel:
    post:
      tags: [Deliveries]
      summary: Отменить доставку (B2B)
      operationId: cancelDelivery
      parameters:
        - in: path
          name: delivery_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CancelDeliveryRequest"
      responses:
        "200":
          description: Доставка отменена
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
        "409":
          description: Невозможно отменить на текущем этапе (INVALID_STATE_TRANSITION)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: INVALID_STATE_TRANSITION
                message: "Cannot cancel delivery in IN_FLIGHT status"
                trace_id: "d9f1b2c3a6"
        "429":
          description: Превышен лимит запросов (RATE_LIMIT_EXCEEDED)
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/XRateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/XRateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/XRateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RateLimitResponse"

  # Optional: WS endpoint described as HTTP GET with 101 (common documentation practice)
  /ws/v1/deliveries/{delivery_id}:
    get:
      tags: [Tracking]
      summary: WebSocket (production) — real-time tracking by delivery_id
      operationId: wsDeliveryTracking
      description: |
        WebSocket endpoint for production delivery tracking.

        URL (wss):
        wss://api.magnumdrone.delivery/ws/v1/deliveries/{delivery_id}

        Server message schemas:
        - TelemetryMessage (type=TELEMETRY)
        - StatusMessage (type=STATUS)
      parameters:
        - in: path
          name: delivery_id
          required: true
          schema:
            type: string
      responses:
        "101":
          description: Switching Protocols (WebSocket established)

webhooks:
  DeliveryStatusEvent:
    post:
      tags: [Webhooks]
      summary: Событие изменения статуса доставки (push to Magnum)
      description: |
        Отправляется на endpoint Magnum (например):
        `https://magnum.kz/api/drone-delivery/events`

        Подпись (HMAC-SHA256):
        Заголовки:
        - `X-Signature: sha256=<hex>`
        - `X-Timestamp: <unix_seconds>`

        Signature = HMAC_SHA256(secret, timestamp + "." + raw_body)

        Magnum должен отклонять события старше 5 минут (replay protection).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebhookEvent"
      responses:
        "200":
          description: Event обработан успешно
        "401":
          description: Неверная подпись / не авторизовано
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: UNAUTHORIZED
                message: "Invalid webhook signature"
                trace_id: "whk-001"
